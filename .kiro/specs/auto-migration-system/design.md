# Design Document

## Overview

The automatic migration system will detect schema changes during deployment and automatically create, name, and apply migration files. This eliminates the manual step of creating migrations while maintaining proper version control and database safety.

## Architecture

### High-Level Flow
```
Schema Change Detection → Migration Creation → Migration Application → Deployment Continue
```

### Components
1. **Schema Diff Detector** - Compares current schema with database state
2. **Migration Name Generator** - Creates descriptive migration names
3. **Auto Migration Creator** - Generates migration files automatically
4. **Fallback Handler** - Uses db push if migration creation fails
5. **Git Integration** - Commits migration files automatically

## Components and Interfaces

### 1. Schema Change Detection Script (`detect-schema-changes.js`)

**Purpose:** Detect if schema.prisma has changes that need migration

**Interface:**
```javascript
async function detectSchemaChanges() {
  // Returns: { hasChanges: boolean, changeType: string, description: string }
}
```

**Implementation:**
- Use `prisma migrate diff` to compare schema with database
- Parse diff output to determine change types
- Return structured information about changes

### 2. Migration Name Generator (`generate-migration-name.js`)

**Purpose:** Create descriptive migration names based on schema changes

**Interface:**
```javascript
function generateMigrationName(changeType, description) {
  // Returns: string (migration name)
}
```

**Naming Rules:**
- Add table: `add_[table_name]_table`
- Add column: `add_[column_name]_to_[table]`
- Remove table: `remove_[table_name]_table`
- Remove column: `remove_[column_name]_from_[table]`
- Modify column: `modify_[table]_[column]`
- Complex changes: `auto_schema_update_[timestamp]`

### 3. Auto Migration Script (`auto-migrate.js`)

**Purpose:** Main orchestrator for automatic migration process

**Interface:**
```javascript
async function autoMigrate() {
  // Returns: { success: boolean, migrationCreated: boolean, fallbackUsed: boolean }
}
```

**Process:**
1. Detect schema changes
2. Generate migration name
3. Create migration file
4. Apply migration
5. Commit to Git (if successful)
6. Fallback to db push (if migration fails)

### 4. Enhanced Deployment Scripts

**Modified Files:**
- `DEPLOY.bat` - Windows batch file
- `.github/workflows/deploy.yml` - GitHub Actions
- `.github/workflows/manual-deploy.yml` - Manual deployment

**Integration Points:**
- Replace `prisma migrate deploy` with `node auto-migrate.js`
- Add error handling and logging
- Maintain backward compatibility

## Data Models

### Migration Metadata
```javascript
{
  timestamp: "20250916123045",
  name: "add_user_table",
  changeType: "add_table",
  description: "Added User model with email and name fields",
  autoGenerated: true,
  fallbackUsed: false
}
```

### Schema Change Detection Result
```javascript
{
  hasChanges: true,
  changeType: "add_table", // add_table, add_column, remove_table, remove_column, modify_column, complex
  tableName: "User",
  columnName: null,
  description: "Added new User table",
  sqlPreview: "CREATE TABLE \"User\" ..."
}
```

## Error Handling

### Migration Creation Failures
1. **Schema Syntax Errors**
   - Detect with `prisma validate`
   - Return clear error message
   - Stop deployment process

2. **Migration Conflicts**
   - Detect with `prisma migrate diff`
   - Attempt automatic resolution
   - Fallback to db push if unresolvable

3. **Database Connection Issues**
   - Retry with exponential backoff
   - Fallback to db push
   - Log detailed error information

### Fallback Strategy
```
Auto Migration Attempt → Migration Creation Failed → Prisma DB Push → Continue Deployment
```

## Testing Strategy

### Unit Tests
- Schema change detection logic
- Migration name generation rules
- Error handling scenarios
- Git integration functions

### Integration Tests
- End-to-end deployment with schema changes
- Fallback mechanism testing
- GitHub Actions workflow testing
- Multiple schema change scenarios

### Test Scenarios
1. **Single Table Addition**
   - Add new model to schema
   - Verify migration created with correct name
   - Verify database updated correctly

2. **Column Modifications**
   - Modify existing model fields
   - Verify migration handles column changes
   - Verify data preservation

3. **Complex Schema Changes**
   - Multiple tables and relationships
   - Verify single migration created
   - Verify all changes applied correctly

4. **Migration Failure Scenarios**
   - Invalid schema syntax
   - Database connection issues
   - Verify fallback to db push works

5. **Git Integration**
   - Verify migration files committed
   - Verify commit messages are descriptive
   - Verify no uncommitted changes remain

## Implementation Files

### New Files to Create
1. `scripts/detect-schema-changes.js`
2. `scripts/generate-migration-name.js`
3. `scripts/auto-migrate.js`
4. `scripts/git-integration.js`

### Modified Files
1. `DEPLOY.bat` - Add auto-migration call
2. `.github/workflows/deploy.yml` - Replace migrate deploy
3. `.github/workflows/manual-deploy.yml` - Replace migrate deploy
4. `package.json` - Add new script commands

### Configuration
- Environment variables for Git configuration
- Prisma configuration for migration settings
- Logging configuration for debugging

## Security Considerations

### Git Credentials
- Use GitHub Actions built-in GITHUB_TOKEN
- Configure Git user for automated commits
- Ensure proper permissions for repository access

### Database Safety
- Always validate schema before migration
- Use transactions where possible
- Maintain migration rollback capability
- Log all migration attempts

### Error Information
- Sanitize error messages in logs
- Avoid exposing sensitive database information
- Provide helpful debugging information

## Performance Considerations

### Schema Diff Performance
- Cache schema comparison results
- Use efficient diff algorithms
- Minimize database queries

### Migration Speed
- Optimize migration file generation
- Use batch operations where possible
- Provide progress feedback for long operations

## Monitoring and Logging

### Migration Logs
```
[AUTO-MIGRATE] Detecting schema changes...
[AUTO-MIGRATE] Changes detected: add_table (User)
[AUTO-MIGRATE] Generated migration: 20250916123045_add_user_table
[AUTO-MIGRATE] Migration created successfully
[AUTO-MIGRATE] Migration applied to database
[AUTO-MIGRATE] Migration committed to Git
[AUTO-MIGRATE] Auto-migration completed successfully
```

### Error Logs
```
[AUTO-MIGRATE] ERROR: Schema validation failed
[AUTO-MIGRATE] ERROR: Migration creation failed, falling back to db push
[AUTO-MIGRATE] WARNING: Using fallback db push method
[AUTO-MIGRATE] SUCCESS: Fallback completed, deployment continuing
```

## Backward Compatibility

### Existing Migrations
- Preserve all existing migration files
- Maintain migration history integrity
- Support manual migration creation alongside auto-migration

### Deployment Methods
- Support both local batch files and GitHub Actions
- Maintain existing deployment interfaces
- Provide migration status in deployment output

### Configuration Options
- Allow disabling auto-migration if needed
- Support manual migration mode
- Provide migration preview mode